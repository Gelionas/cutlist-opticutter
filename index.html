<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CutList → OptiCutter CSV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1e90ff" />

  <!-- iOS Home Screen icon (use the v2 name to bust cache) -->
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-v2.png">
  <!-- Favicons / Android (optional) -->
  <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192-v2.png">
  <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512-v2.png">

  <!-- iOS app-like behavior -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="OptiCutter" />

  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --brand:#1e90ff; --brand-2:#60a5fa;
      --ok:#22c55e; --warn:#f59e0b;
    }
    *{box-sizing:border-box}html,body{height:100%}
    body{
      margin:0; font:16px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:linear-gradient(180deg,#0b1220, #0f172a 30%, #0b1220 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:900px;margin:0 auto;padding:20px 16px 40px}
    header{display:flex;align-items:center;gap:12px;margin:10px 0 18px}
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand-2));
      display:grid;place-items:center; font-weight:800}
    .logo span{color:white}
    h1{font-size:22px;margin:0}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}
    .card{background:rgba(17,24,39,.7);backdrop-filter:saturate(140%) blur(6px);border:1px solid rgba(148,163,184,.15);
      border-radius:18px;padding:14px 14px 16px;margin:12px 0}
    .grid{display:grid;gap:10px}
    @media(min-width:760px){.grid.cols-2{grid-template-columns:1fr 1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:4px 0 6px}
    input, select, textarea{
      width:100%;background:#0b1220;border:1px solid rgba(148,163,184,.25);color:var(--text);
      border-radius:12px;padding:12px 12px;font-size:15px;outline:none
    }
    textarea{min-height:150px;resize:vertical}
    input:focus, textarea:focus, select:focus{border-color:var(--brand)}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    button,.linkbtn{
      appearance:none;border:0;border-radius:14px;padding:12px 14px;font-weight:700;
      background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:white; cursor:pointer
    }
    .outline{background:transparent;color:var(--text);border:1px solid rgba(148,163,184,.3)}
    .ghost{background:transparent;color:var(--muted)}
    .pill{border-radius:999px;padding:8px 10px;font-size:12px;border:1px solid rgba(148,163,184,.25);color:var(--muted)}
    .footer{color:var(--muted);font-size:12px;margin-top:16px}
    .kbd{padding:2px 6px;border-radius:6px;border:1px solid rgba(148,163,184,.35);font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
    .success{color:var(--ok)}
    .warn{color:var(--warn)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"><span>OC</span></div>
      <div>
        <h1>CutList → OptiCutter CSV</h1>
        <div class="sub">Enter your rips (Width, optional Qty). Generate and upload the CSV to OptiCutter.</div>
      </div>
      <span class="pill" id="status">Ready</span>
    </header>

    <!-- Inputs -->
    <div class="card">
      <div class="grid cols-2">
        <div>
          <label for="plan">Plan Name</label>
          <input id="plan" placeholder="e.g., Kitchen – Shaker White">
        </div>
        <div>
          <label for="material">Material</label>
          <input id="material" placeholder="e.g., 3/4&quot; Birch Plywood">
        </div>
      </div>

      <div class="grid cols-2">
        <div>
          <label for="kerf">Kerf (fraction or decimal)</label>
          <input id="kerf" placeholder="e.g., 1/8 or 0.125">
        </div>
        <div class="grid">
          <div class="row">
            <div>
              <label for="sheetL">Sheet Length</label>
              <input id="sheetL" placeholder="e.g., 96">
            </div>
            <div>
              <label for="sheetW">Sheet Width</label>
              <input id="sheetW" placeholder="e.g., 48">
            </div>
            <div>
              <label for="sheetQty">Sheet Qty</label>
              <input id="sheetQty" placeholder="e.g., 2">
            </div>
          </div>
        </div>
      </div>

      <div class="grid cols-2">
        <div class="row">
          <div><label for="trimL">Trim Left</label><input id="trimL" placeholder="0"></div>
          <div><label for="trimR">Trim Right</label><input id="trimR" placeholder="0"></div>
          <div><label for="trimT">Trim Top</label><input id="trimT" placeholder="0"></div>
          <div><label for="trimB">Trim Bottom</label><input id="trimB" placeholder="0"></div>
        </div>
        <div>
          <label for="units">Units</label>
          <select id="units">
            <option value="in">Inches</option>
            <option value="mm">Millimeters</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px">
        <label for="lines">Cut List (one per line)</label>
        <textarea id="lines" class="mono" placeholder="Width[, Qty]
3.5, 4
4 1/2
7-1/4, 2
12"></textarea>
        <div class="hint">
          Format: <span class="mono">Width[, Quantity]</span>. Fractions allowed (<span class="mono">1/8</span>, <span class="mono">3-1/2</span>, <span class="mono">4 3/4</span>). Quantity defaults to 1.
        </div>
      </div>

      <div class="btns">
        <button id="gen">Generate CSV</button>
        <button class="outline" id="download" disabled>Download CSV</button>
        <button class="outline" id="copy" disabled>Copy to Clipboard</button>
        <a class="linkbtn ghost" id="upload" href="https://www.opticutter.com/cut-list-optimizer/import/csv" target="_blank" rel="noopener">Open OptiCutter Upload</a>
      </div>

      <div class="hint" id="msg"></div>
    </div>

    <!-- Preview -->
    <div class="card">
      <label>CSV Preview</label>
      <textarea id="preview" class="mono" style="min-height:180px" readonly></textarea>
      <div class="footer">Pro tip: After you add this page to your Home Screen, iOS will use the custom icon (we cache-busted it with the v2 filename). If you still see an old tile, delete the shortcut and re-add it.</div>
    </div>
  </div>

  <script>
    // === Utilities ===
    const $ = (id)=>document.getElementById(id);
    const NUM = (v)=>Number.isFinite(v)? v : '';
    const storeKey = 'opticutter_v2';

    function saveState(){
      const state = {
        plan: $('plan').value.trim(),
        material: $('material').value.trim(),
        kerf: $('kerf').value.trim(),
        sheetL: $('sheetL').value.trim(),
        sheetW: $('sheetW').value.trim(),
        sheetQty: $('sheetQty').value.trim(),
        trimL: $('trimL').value.trim(),
        trimR: $('trimR').value.trim(),
        trimT: $('trimT').value.trim(),
        trimB: $('trimB').value.trim(),
        units: $('units').value,
        lines: $('lines').value
      };
      localStorage.setItem(storeKey, JSON.stringify(state));
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(storeKey);
        if(!raw) return;
        const s = JSON.parse(raw);
        for(const k in s){
          if($(k)) $(k).value = s[k];
        }
      }catch(_){}
    }

    function fracToDecimal(str){
      // Handles "4 1/2", "4-1/2", "1/2", "3.75"
      if(!str) return NaN;
      const s = String(str).trim().replace(/\u00A0/g,' ');
      if(/^\d+(\.\d+)?$/.test(s)) return parseFloat(s);

      const dash = s.replace(/-/g,' ');
      const parts = dash.split(/\s+/);
      let whole = 0, frac = parts.pop();
      if(parts.length) whole = parseFloat(parts.join(' ')) || 0;

      if(frac && /^\d+\/\d+$/.test(frac)){
        const [n,d] = frac.split('/').map(Number);
        if(d===0) return NaN;
        return whole + (n/d);
      }
      // Fallback try parse again
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : NaN;
    }

    function toUnits(valInInches, units){
      if(units==='mm') return (valInInches * 25.4);
      return valInInches;
    }

    function cleanNumber(val, units){
      // Allow either inches or mm input; if mm selected, treat entered numbers as mm
      // We won't convert user-entered sheet sizes—assume user knows what they're entering.
      // But we normalize fractions only for widths list.
      if(units==='mm'){
        const n = parseFloat(String(val).trim());
        return Number.isFinite(n) ? n : NaN;
      }else{
        // inches, support fractions
        return fracToDecimal(val);
      }
    }

    function csvEscape(v){
      const s = String(v ?? '');
      return (/[",\n]/.test(s)) ? '"' + s.replace(/"/g,'""') + '"' : s;
    }

    // === CSV (simple, works well with OptiCutter import) ===
    function buildCSV(){
      const plan = $('plan').value.trim();
      const material = $('material').value.trim();
      const kerf = $('kerf').value.trim();
      const sheetL = $('sheetL').value.trim();
      const sheetW = $('sheetW').value.trim();
      const sheetQty = $('sheetQty').value.trim();
      const trimL = $('trimL').value.trim() || '0';
      const trimR = $('trimR').value.trim() || '0';
      const trimT = $('trimT').value.trim() || '0';
      const trimB = $('trimB').value.trim() || '0';
      const units = $('units').value;
      const raw = $('lines').value;

      // Parse list
      const rows = [];
      let lineNo = 0;
      for(const line of raw.split('\n')){
        lineNo++;
        const t = line.trim();
        if(!t) continue;
        const parts = t.split(',').map(s=>s.trim());
        const widthStr = parts[0];
        const qtyStr = parts[1] ?? '1';

        const width = cleanNumber(widthStr, units);
        const qty = parseInt(qtyStr,10);
        if(!Number.isFinite(width) || !Number.isFinite(qty) || qty < 1){
          throw new Error(`Check line ${lineNo}: “${line}”`);
        }
        rows.push({ width, qty });
      }

      if(rows.length === 0){
        throw new Error('No items found. Enter at least one line in the cut list.');
      }

      // CSV schema:
      // We'll provide plan/material and sheet settings in header row 0,
      // then one row per item: Item Width + Quantity.
      // This schema is accepted by OptiCutter’s CSV importer.
      const header = [
        'Plan Name','Material','Kerf','Trim Left','Trim Right','Trim Top','Trim Bottom',
        'Sheet Length','Sheet Width','Sheet Quantity','Units',
        'Item Width','Item Quantity'
      ];

      const out = [header.map(csvEscape).join(',')];

      for(const {width, qty} of rows){
        out.push([
          csvEscape(plan),
          csvEscape(material),
          csvEscape(kerf),
          csvEscape(trimL),
          csvEscape(trimR),
          csvEscape(trimT),
          csvEscape(trimB),
          csvEscape(sheetL),
          csvEscape(sheetW),
          csvEscape(sheetQty || ''),
          csvEscape(units),
          csvEscape(width),
          csvEscape(qty)
        ].join(','));
      }

      return out.join('\n');
    }

    // === Actions ===
    function enableActions(ok){
      $('download').disabled = !ok;
      $('copy').disabled = !ok;
      $('status').textContent = ok ? 'CSV ready' : 'Ready';
      $('status').style.color = ok ? 'var(--ok)' : 'var(--muted)';
    }

    function generate(){
      try{
        saveState();
        const csv = buildCSV();
        $('preview').value = csv;
        $('msg').innerHTML = 'CSV generated. <span class="success">Looks good!</span>';
        enableActions(true);
        return csv;
      }catch(err){
        $('preview').value = '';
        $('msg').innerHTML = `<span class="warn">Error:</span> ${err.message || err}`;
        enableActions(false);
        return '';
      }
    }

    function downloadCSV(){
      const csv = $('preview').value;
      if(!csv) return;
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const now = new Date();
      const stamp = now.toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.href = url;
      a.download = `opticutter_${stamp}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 500);
    }

    async function copyCSV(){
      const csv = $('preview').value;
      if(!csv) return;
      try{
        await navigator.clipboard.writeText(csv);
        $('msg').textContent = 'Copied to clipboard.';
      }catch{
        $('msg').textContent = 'Could not copy. (iOS Safari sometimes blocks clipboard outside user gesture.)';
      }
    }

    // === Wire up ===
    loadState();
    enableActions(false);
    $('gen').addEventListener('click', generate);
    $('download').addEventListener('click', downloadCSV);
    $('copy').addEventListener('click', copyCSV);

    // Auto-save on blur
    for(const id of ['plan','material','kerf','sheetL','sheetW','sheetQty','trimL','trimR','trimT','trimB','units','lines']){
      const el = $(id);
      el && el.addEventListener('blur', saveState);
    }

    // If query param ?demo=1, prefill example and auto-generate
    if(new URLSearchParams(location.search).get('demo')==='1'){
      $('plan').value = 'Kitchen A – Shaker White';
      $('material').value = '3/4" Birch Ply';
      $('kerf').value = '1/8';
      $('sheetL').value = '96';
      $('sheetW').value = '48';
      $('sheetQty').value = '2';
      $('trimL').value = '0'; $('trimR').value = '0'; $('trimT').value = '0'; $('trimB').value = '0';
      $('units').value = 'in';
      $('lines').value = '3.5, 4\n4 1/2\n7-1/4, 2\n12';
      generate();
    }
  </script>
</body>
</html>
